# © 2026 月球厨师莱恩 (TPMOONCHEFRYAN) – PolyForm Noncommercial License
# Caddy configuration for TCRN TMS with custom domain support

# Global options
{
    # Email for Let's Encrypt notifications
    email {$ACME_EMAIL:admin@tcrn.app}
    
    # Enable on-demand TLS for custom domains
    on_demand_tls {
        ask http://api:4000/api/v1/internal/domain-check
        interval 2m
        burst 5
    }
    
    # Enable admin API for dynamic config
    admin off
    
    # Logging
    log {
        output stdout
        format json
        level INFO
    }
}

# =====================================
# Main application domain
# =====================================
tcrn.app, www.tcrn.app {
    encode gzip zstd
    
    # API proxy
    handle /api/* {
        reverse_proxy api:4000
    }
    
    # Frontend proxy
    handle {
        reverse_proxy web:3000
    }
    
    # Security headers
    header {
        X-Frame-Options "DENY"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
        X-XSS-Protection "1; mode=block"
        -Server
    }
}

# =====================================
# System subdomain for marshmallow pages
# Wildcard: *.m.tcrn.app
# =====================================
*.m.tcrn.app {
    # Use DNS challenge for wildcard certificate (requires Cloudflare)
    tls {
        dns cloudflare {$CF_API_TOKEN}
    }
    
    encode gzip zstd
    
    # API proxy
    handle /api/* {
        reverse_proxy api:4000
    }
    
    # Frontend proxy (middleware will handle subdomain routing)
    handle {
        reverse_proxy web:3000
    }
    
    # Security headers for public pages
    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }
}

# =====================================
# System subdomain for homepage pages
# Wildcard: *.p.tcrn.app
# =====================================
*.p.tcrn.app {
    tls {
        dns cloudflare {$CF_API_TOKEN}
    }
    
    encode gzip zstd
    
    handle /api/* {
        reverse_proxy api:4000
    }
    
    handle {
        reverse_proxy web:3000
    }
    
    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }
}

# =====================================
# Custom domains (on-demand TLS)
# This catches all other domains pointed to this server
# =====================================
:443 {
    # On-demand TLS for verified custom domains
    tls {
        on_demand
    }
    
    encode gzip zstd
    
    # API proxy
    handle /api/* {
        reverse_proxy api:4000
    }
    
    # Frontend proxy (middleware will handle domain routing)
    handle {
        reverse_proxy web:3000
    }
    
    # Security headers
    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }
}

# =====================================
# Health check endpoint
# =====================================
:80 {
    respond /health "OK" 200
    
    # Redirect HTTP to HTTPS
    @notHealth not path /health
    redir @notHealth https://{host}{uri} permanent
}
