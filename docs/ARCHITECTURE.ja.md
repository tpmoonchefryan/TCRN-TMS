<p align="center">
  <a href="./ARCHITECTURE.md">English</a> |
  <a href="./ARCHITECTURE.zh-CN.md">简体中文</a> |
  <strong>日本語</strong>
</p>

# TCRN TMS - アーキテクチャドキュメント

## システム概要

TCRN TMS は、マイクロサービス指向アーキテクチャで構築されたマルチテナントタレント管理システムです。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         ロードバランサー / CDN                           │
│                        (Cloudflare / AWS CloudFront)                    │
└─────────────────────────────────────────────────────────────────────────┘
                                      │
          ┌───────────────────────────┼───────────────────────────┐
          │                           │                           │
          ▼                           ▼                           ▼
┌─────────────────┐         ┌─────────────────┐         ┌─────────────────┐
│   Web フロント  │         │   API ゲートウェイ│        │  パブリックページ│
│   (Next.js)     │         │   (NestJS)      │         │  (Next.js SSR)  │
│   :3000         │         │   :4000         │         │  /p/* /m/*      │
└─────────────────┘         └─────────────────┘         └─────────────────┘
                                      │
                    ┌─────────────────┼─────────────────┐
                    │                 │                 │
                    ▼                 ▼                 ▼
          ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
          │  PostgreSQL 16  │ │    Redis 7      │ │  PII サービス   │
          │  (マルチテナント)│ │  (キャッシュ/Queue)│ │  (mTLS)         │
          └─────────────────┘ └─────────────────┘ └─────────────────┘
                    │                 │                 │
                    │                 ▼                 │
                    │         ┌─────────────────┐       │
                    │         │  BullMQ Workers │       │
                    │         │  (バックグラウンド)│      │
                    │         └─────────────────┘       │
                    │                                   │
                    ▼                                   ▼
          ┌─────────────────┐                 ┌─────────────────┐
          │     MinIO       │                 │  PII PostgreSQL │
          │  (オブジェクトストア)│              │  (暗号化)       │
          └─────────────────┘                 └─────────────────┘
```

## 技術スタック

| レイヤー | 技術 | 用途 |
|----------|------|------|
| フロントエンド | Next.js 15, React 19, TypeScript | 管理UI、パブリックページ |
| API | NestJS 10, TypeScript | REST API、認証 |
| データベース | PostgreSQL 16 | マルチテナントデータストレージ |
| キャッシュ/キュー | Redis 7 | セッションキャッシュ、BullMQ キュー |
| オブジェクトストレージ | MinIO | レポート、エクスポート、アップロード |
| PII サービス | スタンドアロン NestJS | 隔離された PII データ処理 |
| Worker | Node.js, BullMQ | バックグラウンドジョブ処理 |
| 監視 | OpenTelemetry, Tempo, Prometheus | トレーシング、メトリクス |

## マルチテナントアーキテクチャ

### スキーマベースの分離

各テナントは独自の PostgreSQL スキーマを持ちます：

```
public/              # グローバルメタデータ
  - tenant           # テナントレジストリ
  - global_config    # システム全体の設定
  - email_template   # メールテンプレート（共有）

tenant_template/     # テンプレートスキーマ（新規テナント用にコピー）
  - system_user
  - customer_profile
  - marshmallow_message
  - talent_homepage
  - ...

tenant_<code>/       # テナント別スキーマ
  - tenant_ac        # プラットフォーム管理テナント
  - tenant_demo
  - ...
```

### テナント識別

```typescript
// リクエストコンテキストにテナント情報を含む
interface RequestContext {
  tenantId: string;
  tenantSchemaName: string;
  userId: string;
  permissions: string[];
}

// データベースクエリはスキーマ修飾名を使用
const result = await prisma.$queryRawUnsafe(`
  SELECT * FROM "${tenantSchema}".customer_profile
  WHERE id = $1
`, customerId);
```

## セキュリティアーキテクチャ

### 認証フロー

```
┌──────────┐    POST /auth/login     ┌──────────┐
│ クライアント│ ────────────────────▶  │   API    │
└──────────┘                         └──────────┘
     │                                     │
     │         アクセストークン (JWT)       │
     │  ◀─────────────────────────────────  │
     │         リフレッシュトークン (Cookie) │
     │                                     │
     │    後続リクエストで                  │
     │    Authorization: Bearer <token>    │
     │  ─────────────────────────────────▶ │
     │                                     │
```

### PII データ分離

```
┌─────────────────┐                 ┌─────────────────┐
│   メイン API    │    mTLS/JWT    │   PII サービス  │
│                 │ ──────────────▶│                 │
│  customer_id    │                │  PII データベース│
│  rm_profile_id  │ ◀──────────────│  (暗号化)       │
│  (トークン)     │    PII データ  │                 │
└─────────────────┘                 └─────────────────┘
```

### 技術フィンガープリント

```typescript
// 透かし用のフィンガープリント生成
interface FingerprintPayload {
  userId: string;
  tenantId: string;
  timestamp: number;
  env: string;
  sessionId: string;
}

// レスポンスヘッダーにフィンガープリントを含む
X-TCRN-FP: <encrypted_fingerprint>
X-TCRN-FP-Version: 1
```

### コンテンツセキュリティ

```
┌─────────────────────────────────────────────────────┐
│                  セキュリティレイヤー                 │
├─────────────────────────────────────────────────────┤
│  1. レート制限 (Redis ベース、IP/エンドポイント別)    │
│  2. CAPTCHA 検証 (Cloudflare Turnstile)             │
│  3. UA 検出 (ボット/クローラーブロック)              │
│  4. 不適切語フィルター (多言語、リスクスコアリング)   │
│  5. IP ブロックリスト (ホワイトリスト/ブラックリスト) │
│  6. コンテンツブロックリスト (キーワード/正規表現)    │
└─────────────────────────────────────────────────────┘
```

## 権限システム (RBAC)

### 三段階権限モデル

```
┌───────────────────────────────────────────────────┐
│                   権限状態                         │
├───────────────────────────────────────────────────┤
│  GRANT  │  明示的に許可                           │
│  DENY   │  明示的に拒否（最高優先度）              │
│  UNSET  │  未設定、親から継承                      │
├───────────────────────────────────────────────────┤
│  優先度: DENY > GRANT > UNSET                     │
└───────────────────────────────────────────────────┘
```

### 階層構造

```
テナント
  └── 子会社（ネスト可能）
        └── タレント

ユーザーロール割り当て:
  ユーザー ─── ロール ─── スコープ (テナント/子会社/タレント)
```

### 機能ロール

| ロール | 説明 |
|--------|------|
| ADMIN | 完全な管理権限 |
| TALENT_MANAGER | タレントとカスタマーの管理 |
| VIEWER | 読み取り専用アクセス |
| TALENT_SELF | タレント自己管理 |
| MODERATOR | コンテンツモデレーション |
| SUPPORT | カスタマーサポートアクセス |
| ANALYST | 分析とレポート |

### 権限スナップショット (Redis)

```
Key: perm:{tenant_id}:{user_id}:{scope_type}:{scope_id}
Value: {
  "customer.profile": ["read", "write"],
  "customer.pii": ["read"],
  "homepage.publish": ["execute"],
  ...
}
```

## バックグラウンドジョブ

### キューアーキテクチャ (BullMQ)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              Redis                                       │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌───────┐  │
│  │ import  │ │ report  │ │ export  │ │ email   │ │ marsh-  │ │ log   │  │
│  │ queue   │ │ queue   │ │ queue   │ │ queue   │ │ mallow  │ │ queue │  │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ └───────┘  │
└─────────────────────────────────────────────────────────────────────────┘
           │          │          │          │          │          │
           ▼          ▼          ▼          ▼          ▼          ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                        Worker プロセス                          │
     │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │
     │  │ Import  │ │ Report  │ │ Export  │ │ Email   │ │Marshmallow│  │
     │  │ Worker  │ │ Worker  │ │ Worker  │ │ Worker  │ │ Export   │   │
     │  │ (c:1)   │ │ (c:1)   │ │ (c:1)   │ │ (c:1)   │ │ Worker   │   │
     │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘   │
     └─────────────────────────────────────────────────────────────────┘
```

### ジョブタイプ

| キュー | ジョブタイプ | 説明 |
|--------|-------------|------|
| import | CUSTOMER_IMPORT | CSV/JSON からの一括カスタマーインポート |
| report | MFR_REPORT | メンバーファンレポート生成 |
| export | CUSTOMER_EXPORT | カスタマーデータエクスポート |
| export | MARSHMALLOW_EXPORT | マシュマロメッセージエクスポート |
| email | SEND_EMAIL | 非同期メール配信 |
| log | TECH_EVENT | 非同期イベントログ |
| log | INTEGRATION_LOG | 非同期連携ログ |

### メールサービス連携

```
┌─────────────────┐         ┌─────────────────┐         ┌─────────────────┐
│   API サーバー  │ ──────▶ │  Email キュー   │ ──────▶ │  Email Worker   │
│  sendEmail()    │         │  (BullMQ)       │         │                 │
└─────────────────┘         └─────────────────┘         └─────────────────┘
                                                                 │
                     ┌───────────────────────────────────────────┤
                     │                                           │
                     ▼                                           ▼
           ┌─────────────────┐                         ┌─────────────────┐
           │  PII サービス   │                         │  Tencent SES    │
           │  (メール取得)   │                         │  (メール送信)   │
           └─────────────────┘                         └─────────────────┘
```

## 監視

### OpenTelemetry 設定

```
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  API サーバー│───▶│  OTel Agent  │───▶│  Grafana     │
│              │    │  Collector   │    │  Tempo       │
└──────────────┘    └──────────────┘    └──────────────┘
                           │
                           ▼
                    ┌──────────────┐
                    │  Prometheus  │───▶ Grafana
                    └──────────────┘
```

### サンプリング戦略

| パスパターン | サンプル率 | 理由 |
|--------------|-----------|------|
| 認証/PII | 10% | セキュリティ上重要 |
| レポート | 50% | デバッグに重要 |
| 外部ページ | 0.5% | 高トラフィック |
| その他 API | 1% | カバレッジとコストのバランス |
| エラー（すべて） | 100% | 常にキャプチャ |
| 低速リクエスト (>2s) | 100% | パフォーマンス問題 |

## 外部ページアーキテクチャ

### ホームページビルダー

```
TalentHomepage
  ├── theme: 'default' | 'dark' | 'soft' | 'cute' | 'minimal'
  ├── components: [
  │     { type: 'ProfileCard', props: {...} },
  │     { type: 'SocialLinks', props: {...} },
  │     { type: 'ImageGallery', props: {...} },
  │     { type: 'VideoEmbed', props: {...} },
  │     { type: 'RichText', props: {...} },
  │     { type: 'LinkButton', props: {...} },
  │     { type: 'MarshmallowWidget', props: {...} },
  │     { type: 'Divider', props: {...} },
  │     { type: 'Spacer', props: {...} }
  │   ]
  └── versions: [
        { version: 1, status: 'archived', snapshot: {...} },
        { version: 2, status: 'published', snapshot: {...} },
        { version: 3, status: 'draft', snapshot: {...} }
      ]
```

### ホームページ公開フロー

```
┌──────────┐    PUT /draft     ┌──────────┐    POST /publish   ┌──────────┐
│ エディタ │ ────────────────▶ │  下書き  │ ─────────────────▶ │  公開済み │
│  (React) │                   │ バージョン│                    │ バージョン│
└──────────┘                   └──────────┘                    └──────────┘
     │                              │                               │
     │  自動保存 (5秒デバウンス)    │                               │
     │  LocalStorage (即座)        │                               │
     │                              │                               │
     └──────────────────────────────┘                               │
                                                                    │
                    ┌───────────────────────────────────────────────┤
                    │                                               │
                    ▼                                               ▼
           ┌─────────────────┐                            ┌─────────────────┐
           │  CDN パージ     │                            │  パブリックページ│
           │  (Cloudflare)   │                            │  /p/{path}      │
           └─────────────────┘                            └─────────────────┘
```

### マシュマロ（匿名 Q&A）

```
送信フロー:
  1. クライアント → レート制限チェック (IP + タレント, 60回/分)
  2. クライアント → ハニーポットフィールド検証
  3. クライアント → CAPTCHA 検証 (Cloudflare Turnstile)
     └── 自動モード: 信頼スコアベースの判定
  4. クライアント → 不適切語フィルター (多言語, リスクスコアリング)
  5. クライアント → ブロックリストマッチング
  6. メッセージ作成 (審査待ち)
  7. タレントにメール通知 (設定されている場合)

モデレーションフロー:
  1. タレントが審査待ちメッセージを確認
  2. 承認 / 却下 / フラグ
  3. オプション: 返信 (公開/非公開)
  4. 承認されたメッセージが公開される
```

### 信頼スコアシステム

```
┌─────────────────────────────────────────────────────┐
│                 信頼スコア要因                       │
├─────────────────────────────────────────────────────┤
│  + 成功した CAPTCHA 完了                            │
│  + 一貫したデバイスフィンガープリント               │
│  + メッセージ履歴（承認済み）                       │
│  - CAPTCHA 失敗回数                                 │
│  - 同一 IP からの複数フィンガープリント             │
│  - UA 変更                                          │
│  - ブロックされたメッセージ                         │
├─────────────────────────────────────────────────────┤
│  trusted (80+)    → CAPTCHA 不要                    │
│  neutral (50-79)  → 時々 CAPTCHA                    │
│  suspicious (20-49) → 常に CAPTCHA                  │
│  blocked (<20)    → 全ての送信を拒否                │
└─────────────────────────────────────────────────────┘
```

## デプロイメントアーキテクチャ

### Kubernetes デプロイメント

```yaml
Deployments:
  - tcrn-api (2+ レプリカ, HPA)
  - tcrn-web (2+ レプリカ)
  - tcrn-worker (1-2 レプリカ)
  - tcrn-pii-service (2+ レプリカ, 隔離)

Services:
  - ClusterIP 内部通信用
  - LoadBalancer 外部アクセス用

ConfigMaps & Secrets:
  - 環境設定
  - TLS 証明書
  - API キー
```

### Docker サービス（開発環境）

| サービス | ポート | 用途 |
|----------|--------|------|
| PostgreSQL | 5432 | メインデータベース |
| Redis | 6379 | キャッシュとキュー |
| MinIO | 9000/9001 | オブジェクトストレージ |
| NATS | 4222/8222 | イベントストリーミング |
| Loki | 3100 | ログ集約 |
| Tempo | 3200/4317/4318 | 分散トレーシング |
| PII PostgreSQL | (内部) | PII データベース |
| PII Service | 5100 | PII API |

### ゼロダウンタイムデプロイメント

```yaml
strategy:
  type: RollingUpdate
  rollingUpdate:
    maxUnavailable: 0
    maxSurge: 1
```

## データフロー例

### カスタマー作成

```
1. API が POST /customers を受信
2. 入力を検証 (Valibot)
3. 権限をチェック
4. customer_profile を作成（PII なし）
5. PII サービスを呼び出して PII を保存 → rm_profile_id を取得
6. カスタマーの rm_profile_id を更新
7. 変更をログ (ChangeLog)
8. レスポンスを返す
```

### レポート生成

```
1. API が POST /reports (MFR) を受信
2. 権限を検証
3. ReportJob を作成 (status: pending)
4. BullMQ 'report' キューに追加
5. Worker がジョブをピックアップ
6. フィルターでカスタマーをクエリ
7. PII フィールド → PII サービスをバッチ呼び出し
8. Excel にストリーム書き込み (ExcelJS)
9. MinIO にアップロード
10. ReportJob を更新 (status: completed, fileUrl)
11. 署名付きダウンロード URL を返す
```

### メール送信

```
1. API が emailService.send() を呼び出し
2. ジョブを BullMQ 'email' キューに追加
3. Worker がジョブをピックアップ
4. データベースからメールテンプレートをロード
5. ビジネスメールの場合 → PII サービスから受信者を取得
6. 変数でテンプレートをレンダリング
7. Tencent SES 経由で送信
8. 結果をログ（成功/失敗）
9. 失敗時にリトライ（3回、指数バックオフ）
```

### ホームページ公開

```
1. ユーザーがエディターで「公開」をクリック
2. POST /talents/:id/homepage/publish
3. 下書きの存在を検証
4. バージョンステータスを 'published' に更新
5. ホームページの published_version_id ポインターを更新
6. CDN キャッシュパージをトリガー（非同期）
7. 新しい空の下書きバージョンを作成
8. 成功とホームページ URL を返す
```
