<p align="center">
  <a href="./README.md">English</a> |
  <strong>ç®€ä½“ä¸­æ–‡</strong> |
  <a href="./README.ja.md">æ—¥æœ¬èª</a>
</p>

<h1 align="center">TCRN TMS - è‰ºäººç®¡ç†ç³»ç»Ÿ</h1>

<p align="center">
  <strong>ä¸“ä¸º VTuber/VUP ç»çºªå…¬å¸è®¾è®¡çš„ç»¼åˆ CRM å¹³å°</strong>
</p>

<p align="center">
  <img alt="License" src="https://img.shields.io/badge/license-PolyForm%20NC-blue">
  <img alt="Node" src="https://img.shields.io/badge/node-20%2B-green">
  <img alt="TypeScript" src="https://img.shields.io/badge/typescript-5.8-blue">
  <img alt="PRs Welcome" src="https://img.shields.io/badge/PRs-welcome-brightgreen">
</p>

---

## ï¿½ å¾…åŠäº‹é¡¹

- **é€‚é…å™¨å’Œ Webhook å¼€å‘**
  - å¯¹æ¥ Bilibili ç›´æ’­å¼€æ”¾å¹³å°ï¼Œæ”¯æŒæ›´å¤šé›†æˆåŠŸèƒ½ï¼ˆè‡ªåŠ¨æ›´æ–°è§‚ä¼—ä¿¡æ¯ã€è®°å½•ä¼šç±æœ‰æ•ˆæœŸã€æ¶ˆè´¹è®°å½•ç­‰ï¼‰
  - å¯¹æ¥ä¸­å›½å†…åœ°ç‰©æµå…¬å¸å¼€æ”¾å¹³å°ï¼Œæœªæ¥æ”¯æŒæ›´å¤šä¼šå‘˜å›é¦ˆç›¸å…³åŠŸèƒ½

---

## ï¿½ğŸ“– ç›®å½•

- [å¾…åŠäº‹é¡¹](#-å¾…åŠäº‹é¡¹)
- [é¡¹ç›®ç®€ä»‹](#-é¡¹ç›®ç®€ä»‹)
- [åŠŸèƒ½äº®ç‚¹](#-åŠŸèƒ½äº®ç‚¹)
- [æ ¸å¿ƒæ¨¡å—](#-æ ¸å¿ƒæ¨¡å—)
- [ç³»ç»Ÿæ¶æ„](#-ç³»ç»Ÿæ¶æ„)
- [æŠ€æœ¯æ ˆ](#-æŠ€æœ¯æ ˆ)
- [å¿«é€Ÿå¼€å§‹](#-å¿«é€Ÿå¼€å§‹)
- [ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²](#-ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²)
- [PII ä»£ç†æœåŠ¡éƒ¨ç½²](#-pii-ä»£ç†æœåŠ¡éƒ¨ç½²)
- [API å‚è€ƒ](#-api-å‚è€ƒ)
- [å®‰å…¨æœºåˆ¶](#-å®‰å…¨æœºåˆ¶)
- [è®¸å¯è¯](#-è®¸å¯è¯)

---

## ğŸ¯ é¡¹ç›®ç®€ä»‹

**TCRN TMSï¼ˆè‰ºäººç®¡ç†ç³»ç»Ÿï¼‰** æ˜¯ä¸€ä¸ªä¸“ä¸º VTuberï¼ˆè™šæ‹Ÿä¸»æ’­ï¼‰å’Œ VUPï¼ˆè™šæ‹Ÿ UP ä¸»ï¼‰ç»çºªå…¬å¸è®¾è®¡çš„ç»¼åˆ CRM å¹³å°ã€‚å®ƒæä¾›ä»å®¢æˆ·æ¡£æ¡ˆç®¡ç†åˆ°å¯¹å¤–äº’åŠ¨é¡µé¢çš„ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆã€‚

### é€‚ç”¨äººç¾¤

- **VTuber/VUP ç»çºªå…¬å¸**ï¼šå¤§è§„æ¨¡ç®¡ç†è‰ºäººã€å®¢æˆ·å’Œç²‰ä¸äº’åŠ¨
- **ç‹¬ç«‹åˆ›ä½œè€…**ï¼šé€šè¿‡å¯å®šåˆ¶ä¸»é¡µå»ºç«‹ä¸“ä¸šå½¢è±¡
- **è‰ºäººç»ç†**ï¼šè¿½è¸ªä¼šå‘˜ã€å¤„ç†åŒ¿åé—®ç­”ï¼ˆæ£‰èŠ±ç³–ï¼‰ã€ç”ŸæˆæŠ¥è¡¨
- **ä¼ä¸šå›¢é˜Ÿ**ï¼šå¤šç§Ÿæˆ·æ¶æ„ï¼Œç»†ç²’åº¦ RBAC æƒé™æ§åˆ¶

### æ ¸å¿ƒä¼˜åŠ¿

- **éšç§ä¼˜å…ˆæ¶æ„**ï¼šPIIï¼ˆä¸ªäººèº«ä»½ä¿¡æ¯ï¼‰å­˜å‚¨åœ¨ç‹¬ç«‹çš„åŠ å¯†å¾®æœåŠ¡ä¸­
- **å¤šç§Ÿæˆ·éš”ç¦»**ï¼šæ¯ä¸ªç§Ÿæˆ·æ‹¥æœ‰ç‹¬ç«‹çš„ PostgreSQL Schemaï¼Œå®ç°å®Œå…¨æ•°æ®éš”ç¦»
- **ä¸‰è¯­è¨€æ”¯æŒ**ï¼šå®Œæ•´çš„ä¸­æ–‡ã€è‹±æ–‡ã€æ—¥æ–‡ç•Œé¢æœ¬åœ°åŒ–
- **VTuber ä¸“å±åŠŸèƒ½**ï¼šæ£‰èŠ±ç³–ï¼ˆåŒ¿åé—®ç­”ï¼‰ã€å¯å®šåˆ¶è‰ºäººä¸»é¡µã€ä¼šå‘˜è¿½è¸ª

---

## âœ¨ åŠŸèƒ½äº®ç‚¹

### ğŸ” éšç§ä¼˜å…ˆ PII æ¶æ„

æ‰€æœ‰æ•æ„Ÿå®¢æˆ·æ•°æ®ï¼ˆçœŸå®å§“åã€ç”µè¯å·ç ã€åœ°å€ã€é‚®ç®±ï¼‰å­˜å‚¨åœ¨ç‹¬ç«‹çš„ PII ä»£ç†æœåŠ¡ä¸­ï¼š

- **ä»¤ç‰ŒåŒ–è®¿é—®**ï¼šæœ¬åœ°æ•°æ®åº“ä»…å­˜å‚¨ `rm_profile_id` ä»¤ç‰Œ
- **AES-256-GCM åŠ å¯†**ï¼šé™æ€æ•°æ®ä½¿ç”¨ç§Ÿæˆ·ç‹¬ç«‹ DEK åŠ å¯†
- **mTLS è®¤è¯**ï¼šæœåŠ¡é—´é€šä¿¡é‡‡ç”¨åŒå‘ TLS è®¤è¯
- **çŸ­æœŸ JWT**ï¼šPII æ£€ç´¢ä½¿ç”¨ 5 åˆ†é’Ÿæœ‰æ•ˆæœŸçš„è®¿é—®ä»¤ç‰Œ

### ğŸ¢ å¤šç§Ÿæˆ·ç»„ç»‡æ¶æ„

```
å¹³å°ï¼ˆAC ç§Ÿæˆ·ï¼‰
â””â”€â”€ æ™®é€šç§Ÿæˆ·ï¼ˆå…¬å¸/ç»çºªå…¬å¸ï¼‰
    â””â”€â”€ åˆ†çº§ç›®å½•ï¼ˆéƒ¨é—¨/å›¢é˜Ÿï¼‰
        â””â”€â”€ è‰ºäººï¼ˆç‹¬ç«‹åˆ›ä½œè€…ï¼‰
```

- **Schema çº§éš”ç¦»**ï¼šæ¯ä¸ªç§Ÿæˆ·æ‹¥æœ‰ä¸“ç”¨ PostgreSQL Schemaï¼ˆ`tenant_xxx`ï¼‰
- **å±‚çº§æƒé™**ï¼šè®¾ç½®å’Œè§„åˆ™ä»ç§Ÿæˆ· â†’ åˆ†çº§ç›®å½• â†’ è‰ºäººçº§è”ä¼ é€’
- **è·¨ç§Ÿæˆ·ç®¡ç†**ï¼šå¹³å°ç®¡ç†å‘˜å¯ç®¡ç†æ‰€æœ‰ç§Ÿæˆ·

### ğŸ›¡ï¸ ä¸‰æ€ RBAC æƒé™ç³»ç»Ÿ

ä¸ä¼ ç»Ÿçš„æˆæƒ/æ‹’ç»ç³»ç»Ÿä¸åŒï¼ŒTCRN TMS å®ç°äº†ä¸‰æ€æ¨¡å‹ï¼š

| çŠ¶æ€ | æè¿° | ä¼˜å…ˆçº§ |
|------|------|--------|
| **Denyï¼ˆæ‹’ç»ï¼‰** | æ˜ç¡®ç¦æ­¢ | æœ€é«˜ |
| **Grantï¼ˆæˆäºˆï¼‰** | æ˜ç¡®å…è®¸ | ä¸­ç­‰ |
| **Unsetï¼ˆæœªè®¾å®šï¼‰** | æœªé…ç½® | æœ€ä½ |

**åŠŸèƒ½å‹è§’è‰²**ï¼š`ADMIN`ã€`TALENT_MANAGER`ã€`VIEWER`ã€`TALENT_SELF`ã€`MODERATOR`ã€`SUPPORT`ã€`ANALYST`

### ğŸ¡ æ£‰èŠ±ç³–åŒ¿åé—®ç­”ç³»ç»Ÿ

çµæ„Ÿæ¥è‡ªæ—¥æœ¬"æ£‰èŠ±ç³–"æœåŠ¡çš„å®Œæ•´åŒ¿åæé—®ç®±ç³»ç»Ÿï¼š

- **æ™ºèƒ½éªŒè¯ç **ï¼šä¸‰ç§æ¨¡å¼ï¼ˆå§‹ç»ˆ/ä»ä¸/è‡ªåŠ¨ï¼‰ï¼Œå¸¦ä¿¡ä»»è¯„åˆ†
- **å†…å®¹å®¡æ ¸**ï¼šå¤šè¯­è¨€è„è¯è¿‡æ»¤å™¨ï¼Œå¸¦é£é™©è¯„åˆ†
- **å¤–éƒ¨å±è”½è¯**ï¼šå±è”½ URLã€åŸŸåå’Œå…³é”®è¯æ¨¡å¼
- **è¡¨æƒ…ååº”**ï¼šç²‰ä¸å¯å¯¹å·²å®¡æ ¸æ¶ˆæ¯è¿›è¡Œè¡¨æƒ…ååº”
- **å¯¼å‡ºåŠŸèƒ½**ï¼šæ”¯æŒå¯¼å‡ºæ¶ˆæ¯ä¸º CSV/JSON/XLSX

### ğŸ“Š MFR æŠ¥è¡¨ç”Ÿæˆ

ç”Ÿæˆå…¨é¢çš„**ä¼šå‘˜åé¦ˆæŠ¥è¡¨**ï¼š

- åŒ…å« PII çš„ä¼šå‘˜æ¡£æ¡ˆï¼ˆé€šè¿‡å®‰å…¨æ£€ç´¢ï¼‰
- å¹³å°èº«ä»½ï¼ˆYouTubeã€Bilibili ç­‰ï¼‰
- ä¼šå‘˜çŠ¶æ€å’Œåˆ°æœŸè¿½è¸ª
- å¼‚æ­¥ç”Ÿæˆï¼Œå¸¦è¿›åº¦è¿½è¸ª
- é€šè¿‡ MinIO é¢„ç­¾å URL ç›´æ¥ä¸‹è½½

### ğŸ” å…¨é¢å®¡è®¡æ—¥å¿—

ä¸‰ç§ç±»å‹çš„æ—¥å¿—ï¼Œè‡ªåŠ¨ PII è„±æ•ï¼š

| æ—¥å¿—ç±»å‹ | ç”¨é€” | ä¿ç•™æœŸ |
|----------|------|--------|
| **å˜æ›´æ—¥å¿—** | UI è§¦å‘çš„ä¸šåŠ¡å˜æ›´ | 60 å¤©ï¼ˆç”Ÿäº§ï¼‰ |
| **æŠ€æœ¯äº‹ä»¶æ—¥å¿—** | ç³»ç»Ÿäº‹ä»¶å’Œé”™è¯¯ | 60 å¤©ï¼ˆç”Ÿäº§ï¼‰ |
| **é›†æˆæ—¥å¿—** | å¤–éƒ¨ API è°ƒç”¨å’Œ Webhook | 60 å¤©ï¼ˆç”Ÿäº§ï¼‰ |

Loki é›†æˆæ”¯æŒè·¨æ‰€æœ‰æ—¥å¿—çš„å…¨æ–‡æœç´¢ã€‚

---

## ğŸ“¦ æ ¸å¿ƒæ¨¡å—

### å®¢æˆ·ç®¡ç†

| åŠŸèƒ½ | æè¿° |
|------|------|
| **ä¸ªäººæ¡£æ¡ˆ** | çœŸå®å§“åã€æ˜µç§°ã€è”ç³»æ–¹å¼ã€å‡ºç”Ÿæ—¥æœŸ |
| **ä¼ä¸šæ¡£æ¡ˆ** | å…¬å¸åç§°ã€æ³¨å†Œå·ã€ç¨å· |
| **å¹³å°èº«ä»½** | YouTubeã€Bilibiliã€Twitchã€Twitter UIDï¼Œå¸¦å†å²è¿½è¸ª |
| **ä¼šå‘˜è®°å½•** | ç±»åˆ«ã€ç±»å‹ã€ç­‰çº§ï¼Œæ”¯æŒè‡ªåŠ¨ç»­è´¹ |
| **å¤–éƒ¨ ID** | å°†å®¢æˆ·æ˜ å°„åˆ°å¤–éƒ¨ç³»ç»Ÿï¼ˆCRMã€å·¥å•ç³»ç»Ÿï¼‰ |
| **æ‰¹é‡å¯¼å…¥** | CSV å¯¼å…¥ï¼Œå¸¦éªŒè¯å’Œé”™è¯¯æŠ¥å‘Š |
| **æ‰¹é‡æ“ä½œ** | æ‰¹é‡æ›´æ–°æ ‡ç­¾/çŠ¶æ€/ä¼šå‘˜ |

### ä¸»é¡µç®¡ç†

ä¸ºè‰ºäººæä¾›æ‹–æ‹½å¼ä¸»é¡µç¼–è¾‘å™¨ï¼š

- **ç»„ä»¶åº“**ï¼šHeroã€å…³äºã€ç¤¾äº¤é“¾æ¥ã€å›¾åº“ã€æ—¶é—´çº¿ã€æ£‰èŠ±ç³–ç»„ä»¶
- **ä¸»é¢˜ç³»ç»Ÿ**ï¼š5 ç§é¢„è®¾ï¼ˆé»˜è®¤ã€æ·±è‰²ã€å¯çˆ±ã€ä¸“ä¸šã€æç®€ï¼‰+ è‡ªå®šä¹‰é¢œè‰²
- **ç‰ˆæœ¬å†å²**ï¼šå›æ»šåˆ°ä»»æ„å·²å‘å¸ƒç‰ˆæœ¬
- **è‡ªå®šä¹‰åŸŸå**ï¼šæ”¯æŒè‰ºäººè‡ªæœ‰åŸŸåï¼Œå¸¦ DNS éªŒè¯
- **SEO ä¼˜åŒ–**ï¼šè‡ªåŠ¨ç”Ÿæˆ meta æ ‡ç­¾å’Œ Open Graph æ”¯æŒ

### å®‰å…¨ç®¡ç†

| åŠŸèƒ½ | æè¿° |
|------|------|
| **å±è”½è¯** | å…³é”®è¯å’Œæ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼ï¼Œç”¨äºå†…å®¹è¿‡æ»¤ |
| **IP è§„åˆ™** | ç™½åå•/é»‘åå•ï¼Œæ”¯æŒ CIDR |
| **è¯·æ±‚é™æµ** | åŸºäº Redis çš„ç«¯ç‚¹çº§é™æµ |
| **UA æ£€æµ‹** | å±è”½å·²çŸ¥æœºå™¨äºº/çˆ¬è™« User-Agent |
| **æŠ€æœ¯æŒ‡çº¹** | éšæ€§æ°´å°ï¼Œç”¨äºæ•°æ®æ³„éœ²è¿½è¸ª |

### é‚®ä»¶æœåŠ¡

é›†æˆè…¾è®¯äº‘ SESï¼š

- **æ¨¡æ¿ç³»ç»Ÿ**ï¼šå¤šè¯­è¨€æ¨¡æ¿ï¼ˆä¸­/è‹±/æ—¥ï¼‰ï¼Œå¸¦å˜é‡æ›¿æ¢
- **é˜Ÿåˆ—å¤„ç†**ï¼šBullMQ Workerï¼Œå¸¦é‡è¯•å’Œé™æµ
- **é¢„ç½®æ¨¡æ¿**ï¼šå¯†ç é‡ç½®ã€ç™»å½•éªŒè¯ã€ä¼šå‘˜æé†’

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚             äº‘æœåŠ¡æä¾›å•†                 â”‚
                                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                                    â”‚  â”‚           è´Ÿè½½å‡è¡¡å™¨             â”‚   â”‚
                                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                    â”‚                â”‚                        â”‚
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
               â”‚                     â”‚                â”‚                    â”‚  â”‚
               â–¼                     â–¼                â–¼                    â–¼  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
        â”‚   Next.js   â”‚       â”‚   NestJS    â”‚  â”‚   Worker    â”‚     â”‚  MinIO  â”‚â”‚
        â”‚   (Web UI)  â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚   (API)     â”‚  â”‚  (BullMQ)   â”‚     â”‚  (S3)   â”‚â”‚
        â”‚   :3000     â”‚       â”‚   :4000     â”‚  â”‚             â”‚     â”‚  :9000  â”‚â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
                                     â”‚                â”‚                       â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”                  â”‚
                              â”‚             â”‚              â”‚                  â”‚
                              â–¼             â–¼              â–¼                  â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
                       â”‚PostgreSQL â”‚ â”‚   Redis   â”‚  â”‚   NATS    â”‚             â”‚
                       â”‚   :5432   â”‚ â”‚   :6379   â”‚  â”‚   :4222   â”‚             â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
                              â”‚                                               â”‚
                              â”‚ mTLS                                          â”‚
                              â–¼                                               â”‚
               â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€                 â”‚
              â”‚         éš”ç¦»çš„ PII ç¯å¢ƒ                    â”‚                  â”‚
              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                  â”‚
              â”‚  â”‚  PII ä»£ç†       â”‚  â”‚  PII æ•°æ®åº“     â”‚  â”‚                  â”‚
              â”‚  â”‚  æœåŠ¡ :5100     â”‚â”€â”€â”‚  PostgreSQL     â”‚  â”‚                  â”‚
              â”‚  â”‚  (AES-256-GCM)  â”‚  â”‚  (åŠ å¯†å­˜å‚¨)     â”‚  â”‚                  â”‚
              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                  â”‚
               â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€                 â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

1. **Web UI** â†’ **API ç½‘å…³**ï¼ˆNestJSï¼‰å¤„ç†æ‰€æœ‰ä¸šåŠ¡æ“ä½œ
2. **API** éªŒè¯ JWT å¹¶æ£€æŸ¥ Redis æƒé™å¿«ç…§
3. é PII æ•°æ®å­˜å‚¨åœ¨ç§Ÿæˆ·ç‰¹å®šçš„ PostgreSQL Schema ä¸­
4. PII æ£€ç´¢ï¼šAPI ç­¾å‘çŸ­æœŸ JWT â†’ PII ä»£ç† â†’ åŠ å¯†å­˜å‚¨
5. åå°ä»»åŠ¡ç”± BullMQ Worker å¤„ç†
6. æ–‡ä»¶å­˜å‚¨åœ¨ MinIOï¼Œé€šè¿‡é¢„ç­¾å URL ä¸‹è½½

---

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯ | ç‰ˆæœ¬ |
|------|------|------|
| **å‰ç«¯** | Next.js | 16.1.1 |
| | React | 19.1.1 |
| | TypeScript | 5.8.3 |
| | Tailwind CSS | 3.4.17 |
| | Zustand | 5.0.5 |
| **åç«¯** | NestJS | 11.1.6 |
| | Prisma ORM | 6.14.0 |
| | BullMQ | 5.66.5 |
| **æ•°æ®åº“** | PostgreSQL | 16 |
| | Redis | 7 |
| **å­˜å‚¨** | MinIO | Latest |
| **æ¶ˆæ¯** | NATS JetStream | 2 |
| **å¯è§‚æµ‹æ€§** | OpenTelemetry | - |
| | Prometheus | - |
| | Grafana Loki | 2.9.0 |
| | Grafana Tempo | - |
| **éƒ¨ç½²** | Docker | - |
| | Kubernetes | - |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Node.js 20+ï¼ˆæ¨è LTS ç‰ˆæœ¬ï¼‰
- pnpm 9.15.4+
- Docker å’Œ Docker Compose
- PostgreSQL 16+ï¼ˆæˆ–ä½¿ç”¨ Dockerï¼‰
- Redis 7+ï¼ˆæˆ–ä½¿ç”¨ Dockerï¼‰

### å¼€å‘ç¯å¢ƒé…ç½®

```bash
# 1. å…‹éš†ä»“åº“
git clone https://github.com/tpmoonchefryan/tcrn-tms.git
cd tcrn-tms

# 2. å®‰è£…ä¾èµ–
pnpm install

# 3. å¯åŠ¨åŸºç¡€è®¾æ–½æœåŠ¡
docker-compose up -d postgres redis minio nats loki tempo pii-postgres pii-service

# 4. é…ç½®ç¯å¢ƒå˜é‡
cp .env.sample .env.local
# ç¼–è¾‘ .env.local å¡«å…¥ä½ çš„é…ç½®

# 5. åˆå§‹åŒ–æ•°æ®åº“
cd packages/database
pnpm db:apply-migrations
pnpm db:sync-schemas
pnpm db:seed
cd ../..

# 6. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
pnpm dev
```

### è®¿é—®åœ°å€

| æœåŠ¡ | URL |
|------|-----|
| Web ç•Œé¢ | http://localhost:3000 |
| API æ¥å£ | http://localhost:4000 |
| API æ–‡æ¡£ | http://localhost:4000/api/docs |
| MinIO æ§åˆ¶å° | http://localhost:9001 |
| NATS ç›‘æ§ | http://localhost:8222 |

### é»˜è®¤å‡­è¯

**ACï¼ˆå¹³å°ç®¡ç†å‘˜ï¼‰ç§Ÿæˆ·ï¼š**
| å­—æ®µ | å€¼ |
|------|-----|
| ç§Ÿæˆ·ä»£ç  | AC |
| ç”¨æˆ·å | ac_admin |
| å¯†ç  | (åœ¨ç§å­æ–‡ä»¶ä¸­è®¾ç½®ï¼Œè§ `00-ac-tenant.ts`) |

---

## ğŸŒ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

æœ¬èŠ‚ä»‹ç»å¦‚ä½•å°† TCRN TMS ä¸»åº”ç”¨éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨ã€‚

### åŸºç¡€è®¾æ–½è¦æ±‚

| ç»„ä»¶ | æœ€ä½é…ç½® | æ¨èé…ç½® |
|------|----------|----------|
| **åº”ç”¨æœåŠ¡å™¨** | 2 vCPU, 4GB RAM | 4 vCPU, 8GB RAM |
| **PostgreSQL** | 2 vCPU, 4GB RAM, 50GB SSD | 4 vCPU, 8GB RAM, 100GB SSD |
| **Redis** | 1 vCPU, 1GB RAM | 2 vCPU, 2GB RAM |
| **MinIO** | 2 vCPU, 2GB RAM, 100GB SSD | 4 vCPU, 4GB RAM, 500GB SSD |

### éƒ¨ç½²æ–¹å¼

#### æ–¹å¼ä¸€ï¼šDocker Composeï¼ˆå•æœåŠ¡å™¨ï¼‰

é€‚ç”¨äºï¼šå°å‹éƒ¨ç½²ã€æµ‹è¯•ç¯å¢ƒ

```bash
# 1. å‡†å¤‡æœåŠ¡å™¨
ssh your-server
sudo apt update && sudo apt install -y docker.io docker-compose-plugin

# 2. å…‹éš†å¹¶é…ç½®
git clone https://github.com/tpmoonchefryan/tcrn-tms.git
cd tcrn-tms
cp .env.sample .env

# 3. é…ç½®ç”Ÿäº§ç¯å¢ƒå˜é‡
cat > .env << 'EOF'
# æ•°æ®åº“
POSTGRES_USER=tcrn_prod
POSTGRES_PASSWORD=$(openssl rand -hex 32)
POSTGRES_DB=tcrn_tms
DATABASE_URL=postgresql://tcrn_prod:${POSTGRES_PASSWORD}@postgres:5432/tcrn_tms

# Redis
REDIS_URL=redis://redis:6379

# å®‰å…¨
JWT_SECRET=$(openssl rand -hex 32)
JWT_REFRESH_SECRET=$(openssl rand -hex 32)
FINGERPRINT_SECRET_KEY=$(openssl rand -hex 32)
FINGERPRINT_KEY_VERSION=v1

# MinIO
MINIO_ROOT_USER=minioadmin
MINIO_ROOT_PASSWORD=$(openssl rand -hex 32)
MINIO_ENDPOINT=http://minio:9000

# PII æœåŠ¡ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®ç‹¬ç«‹æœåŠ¡å™¨ï¼‰
PII_SERVICE_URL=https://pii.your-domain.com:5100
PII_SERVICE_MTLS_ENABLED=true

# åº”ç”¨
NODE_ENV=production
NEXT_PUBLIC_API_URL=https://api.your-domain.com
NEXT_PUBLIC_APP_URL=https://app.your-domain.com

# é‚®ä»¶ï¼ˆè…¾è®¯äº‘ SESï¼‰
TENCENT_SES_SECRET_ID=your-secret-id
TENCENT_SES_SECRET_KEY=your-secret-key
TENCENT_SES_REGION=ap-hongkong
TENCENT_SES_FROM_ADDRESS=noreply@your-domain.com
EOF

# 4. æ„å»ºå¹¶éƒ¨ç½²
docker-compose -f docker-compose.yml build
docker-compose -f docker-compose.yml up -d

# 5. åˆå§‹åŒ–æ•°æ®åº“
docker-compose exec api pnpm db:apply-migrations
docker-compose exec api pnpm db:sync-schemas
docker-compose exec api pnpm db:seed
```

#### æ–¹å¼äºŒï¼šKubernetesï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰

é€‚ç”¨äºï¼šé«˜å¯ç”¨ã€è‡ªåŠ¨æ‰©å±•ã€ä¼ä¸šçº§éƒ¨ç½²

```bash
# 1. åˆ›å»ºå‘½åç©ºé—´å’Œå¯†é’¥
kubectl create namespace tcrn-tms
kubectl apply -f infra/k8s/secrets/

# 2. éƒ¨ç½²åŸºç¡€è®¾æ–½
kubectl apply -f infra/k8s/postgres/
kubectl apply -f infra/k8s/redis/
kubectl apply -f infra/k8s/minio/
kubectl apply -f infra/k8s/nats/

# 3. ç­‰å¾…åŸºç¡€è®¾æ–½å°±ç»ª
kubectl wait --for=condition=ready pod -l app=postgres -n tcrn-tms --timeout=300s

# 4. éƒ¨ç½²åº”ç”¨
kubectl apply -f infra/k8s/deployments/

# 5. é…ç½® Ingress
kubectl apply -f infra/k8s/ingress/

# 6. è¿è¡Œæ•°æ®åº“è¿ç§»ï¼ˆä¸€æ¬¡æ€§ä»»åŠ¡ï¼‰
kubectl apply -f infra/k8s/jobs/db-migrate.yaml
```

**Kubernetes ç‰¹æ€§ï¼š**

- **æ»šåŠ¨æ›´æ–°**ï¼š`maxUnavailable: 0` å®ç°é›¶åœæœºéƒ¨ç½²
- **æ°´å¹³ Pod è‡ªåŠ¨æ‰©å±•ï¼ˆHPAï¼‰**ï¼šåŸºäº CPU/å†…å­˜è‡ªåŠ¨æ‰©å±•
- **Pod ä¸­æ–­é¢„ç®—ï¼ˆPDBï¼‰**ï¼šæ›´æ–°æœŸé—´ä¿æŒæœ€å°å‰¯æœ¬æ•°
- **å¥åº·æ£€æŸ¥**ï¼šæ‰€æœ‰æœåŠ¡é…ç½®å°±ç»ªå’Œå­˜æ´»æ¢é’ˆ

### SSL/TLS é…ç½®

```nginx
# Nginx åå‘ä»£ç†é…ç½®ç¤ºä¾‹
server {
    listen 443 ssl http2;
    server_name app.your-domain.com;

    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

server {
    listen 443 ssl http2;
    server_name api.your-domain.com;

    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    location / {
        proxy_pass http://localhost:4000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### ç¯å¢ƒæ£€æŸ¥æ¸…å•

- [ ] PostgreSQL å¯ç”¨ TLS
- [ ] Redis å¯ç”¨è®¤è¯
- [ ] MinIO å¯ç”¨ HTTPS
- [ ] ç”Ÿæˆ JWT å¯†é’¥ï¼ˆè‡³å°‘ 32 å­—ç¬¦ï¼‰
- [ ] é…ç½®æŒ‡çº¹å¯†é’¥
- [ ] é…ç½® PII æœåŠ¡ URLï¼ˆå‚è§ä¸‹ä¸€èŠ‚ï¼‰
- [ ] é…ç½®é‚®ä»¶æœåŠ¡å‡­è¯
- [ ] å®æ–½å¤‡ä»½ç­–ç•¥
- [ ] é…ç½®ç›‘æ§å’Œå‘Šè­¦

---

## ğŸ”’ PII ä»£ç†æœåŠ¡éƒ¨ç½²

å‡ºäºå®‰å…¨åˆè§„è¦æ±‚ï¼ŒPII ä»£ç†æœåŠ¡å¿…é¡»éƒ¨ç½²åœ¨ä¸ä¸»åº”ç”¨**ç‹¬ç«‹çš„æœåŠ¡å™¨**ä¸Šã€‚

### æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¸»åº”ç”¨æœåŠ¡å™¨                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚   Web UI    â”‚   â”‚   API       â”‚   â”‚   Worker    â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                           â”‚                  â”‚                      â”‚
â”‚                           â”‚   JWT + mTLS     â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚                  â”‚
                            â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PII ä»£ç†æœåŠ¡å™¨ï¼ˆéš”ç¦»ç¯å¢ƒï¼‰                        â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    PII ä»£ç†æœåŠ¡                              â”‚   â”‚
â”‚  â”‚   - JWT éªŒè¯                                                 â”‚   â”‚
â”‚  â”‚   - AES-256-GCM åŠ å¯†/è§£å¯†                                   â”‚   â”‚
â”‚  â”‚   - ç§Ÿæˆ·ç‹¬ç«‹ DEK ç®¡ç†                                       â”‚   â”‚
â”‚  â”‚   - å®¡è®¡æ—¥å¿—                                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    PII æ•°æ®åº“                                â”‚   â”‚
â”‚  â”‚   - é™æ€åŠ å¯†                                                 â”‚   â”‚
â”‚  â”‚   - ç½‘ç»œéš”ç¦»                                                 â”‚   â”‚
â”‚  â”‚   - ç¦æ­¢ç›´æ¥å¤–éƒ¨è®¿é—®                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æœåŠ¡å™¨è¦æ±‚

| ç»„ä»¶ | è§„æ ¼ |
|------|------|
| **æ“ä½œç³»ç»Ÿ** | Ubuntu 22.04 LTS æˆ–æ›´é«˜ç‰ˆæœ¬ |
| **CPU** | 2+ vCPU |
| **å†…å­˜** | 4GB+ |
| **å­˜å‚¨** | 50GB+ SSDï¼ˆåŠ å¯†ï¼‰ |
| **ç½‘ç»œ** | ä¸ä¸»æœåŠ¡å™¨çš„ç§æœ‰ç½‘ç»œæˆ– VPN |

### æ­¥éª¤ 1ï¼šå‡†å¤‡ PII æœåŠ¡å™¨

```bash
# SSH è¿æ¥åˆ° PII æœåŠ¡å™¨
ssh pii-server

# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£… Docker
curl -fsSL https://get.docker.com | sudo sh
sudo usermod -aG docker $USER

# å®‰è£…å¿…è¦å·¥å…·
sudo apt install -y openssl ufw
```

### æ­¥éª¤ 2ï¼šé…ç½®é˜²ç«å¢™

```bash
# å…è®¸ SSH
sudo ufw allow ssh

# ä»…å…è®¸ä¸»åº”ç”¨æœåŠ¡å™¨è®¿é—® PII æœåŠ¡ç«¯å£
sudo ufw allow from ä¸»æœåŠ¡å™¨IP to any port 5100

# å¯ç”¨é˜²ç«å¢™
sudo ufw enable
```

### æ­¥éª¤ 3ï¼šç”Ÿæˆ mTLS è¯ä¹¦

```bash
# åˆ›å»ºè¯ä¹¦ç›®å½•
mkdir -p ~/pii-certs && cd ~/pii-certs

# ç”Ÿæˆ CA è¯ä¹¦
openssl genrsa -out ca.key 4096
openssl req -new -x509 -days 3650 -key ca.key -out ca.crt \
    -subj "/C=CN/ST=State/L=City/O=YourOrg/CN=TCRN-TMS-CA"

# ä¸º PII æœåŠ¡ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦
openssl genrsa -out server.key 4096
openssl req -new -key server.key -out server.csr \
    -subj "/C=CN/ST=State/L=City/O=YourOrg/CN=pii.your-domain.com"
openssl x509 -req -days 365 -in server.csr -CA ca.crt -CAkey ca.key \
    -CAcreateserial -out server.crt

# ä¸ºä¸»åº”ç”¨ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦
openssl genrsa -out client.key 4096
openssl req -new -key client.key -out client.csr \
    -subj "/C=CN/ST=State/L=City/O=YourOrg/CN=main-app"
openssl x509 -req -days 365 -in client.csr -CA ca.crt -CAkey ca.key \
    -CAcreateserial -out client.crt

# å°†å®¢æˆ·ç«¯è¯ä¹¦å¤åˆ¶åˆ°ä¸»åº”ç”¨æœåŠ¡å™¨
scp ca.crt client.crt client.key main-server:/path/to/certs/
```

### æ­¥éª¤ 4ï¼šéƒ¨ç½² PII æœåŠ¡

```bash
# åˆ›å»ºéƒ¨ç½²ç›®å½•
mkdir -p ~/pii-service && cd ~/pii-service

# åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
cat > .env << 'EOF'
# PII æ•°æ®åº“
PII_POSTGRES_USER=pii_admin
PII_POSTGRES_PASSWORD=åœ¨æ­¤ç”Ÿæˆå¼ºå¯†ç 
PII_POSTGRES_DB=pii_vault
PII_DATABASE_URL=postgresql://pii_admin:${PII_POSTGRES_PASSWORD}@pii-postgres:5432/pii_vault

# åŠ å¯†
PII_MASTER_KEY=åœ¨æ­¤ç”Ÿæˆ64å­—ç¬¦åå…­è¿›åˆ¶å¯†é’¥
PII_KEY_VERSION=v1

# JWT éªŒè¯ï¼ˆå¿…é¡»ä¸ä¸»åº”ç”¨ä¸€è‡´ï¼‰
JWT_SECRET=ä¸ä¸»åº”ç”¨ç›¸åŒçš„JWTå¯†é’¥

# mTLS
MTLS_ENABLED=true
MTLS_CA_CERT=/certs/ca.crt
MTLS_SERVER_CERT=/certs/server.crt
MTLS_SERVER_KEY=/certs/server.key

# æœåŠ¡å™¨
PORT=5100
NODE_ENV=production
EOF

# åˆ›å»º docker-compose æ–‡ä»¶
cat > docker-compose.yml << 'EOF'
version: '3.8'

services:
  pii-postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: ${PII_POSTGRES_USER}
      POSTGRES_PASSWORD: ${PII_POSTGRES_PASSWORD}
      POSTGRES_DB: ${PII_POSTGRES_DB}
    volumes:
      - pii_data:/var/lib/postgresql/data
    networks:
      - pii-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PII_POSTGRES_USER} -d ${PII_POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  pii-service:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "5100:5100"
    environment:
      - DATABASE_URL=${PII_DATABASE_URL}
      - PII_MASTER_KEY=${PII_MASTER_KEY}
      - PII_KEY_VERSION=${PII_KEY_VERSION}
      - JWT_SECRET=${JWT_SECRET}
      - MTLS_ENABLED=${MTLS_ENABLED}
      - MTLS_CA_CERT=${MTLS_CA_CERT}
      - MTLS_SERVER_CERT=${MTLS_SERVER_CERT}
      - MTLS_SERVER_KEY=${MTLS_SERVER_KEY}
      - PORT=${PORT}
      - NODE_ENV=${NODE_ENV}
    volumes:
      - ~/pii-certs:/certs:ro
    depends_on:
      pii-postgres:
        condition: service_healthy
    networks:
      - pii-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5100/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  pii-network:
    driver: bridge

volumes:
  pii_data:
EOF

# å¤åˆ¶ PII æœåŠ¡æºç æˆ–ä»é•œåƒä»“åº“æ‹‰å–
# æ–¹å¼ Aï¼šä»æºç æ„å»º
git clone https://github.com/tpmoonchefryan/tcrn-tms.git
cp -r tcrn-tms/apps/pii-service/* .

# æ–¹å¼ Bï¼šæ‹‰å–é¢„æ„å»ºé•œåƒ
# ä¿®æ”¹ docker-compose.yml ä½¿ç”¨ image: your-registry/pii-service:latest

# éƒ¨ç½²
docker-compose up -d

# åˆå§‹åŒ– PII æ•°æ®åº“
docker-compose exec pii-service pnpm db:push
```

### æ­¥éª¤ 5ï¼šé…ç½®ä¸»åº”ç”¨

åœ¨ä¸»åº”ç”¨æœåŠ¡å™¨ä¸Šæ›´æ–°ç¯å¢ƒå˜é‡ï¼š

```bash
# æ·»åŠ åˆ° .env æˆ– .env.local
PII_SERVICE_URL=https://pii.your-domain.com:5100
PII_SERVICE_MTLS_ENABLED=true
PII_SERVICE_CA_CERT=/path/to/certs/ca.crt
PII_SERVICE_CLIENT_CERT=/path/to/certs/client.crt
PII_SERVICE_CLIENT_KEY=/path/to/certs/client.key
```

### æ­¥éª¤ 6ï¼šéªŒè¯éƒ¨ç½²

```bash
# åœ¨ PII æœåŠ¡å™¨ä¸Š - æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
curl -k https://localhost:5100/health

# åœ¨ä¸»æœåŠ¡å™¨ä¸Š - æµ‹è¯• PII è¿æ¥ï¼ˆä½¿ç”¨ mTLSï¼‰
curl --cacert /path/to/ca.crt \
     --cert /path/to/client.crt \
     --key /path/to/client.key \
     https://pii.your-domain.com:5100/health
```

### å®‰å…¨æ£€æŸ¥æ¸…å•

- [ ] PII æœåŠ¡å™¨ä½äºç‹¬ç«‹çš„ç‰©ç†/è™šæ‹Ÿæœºå™¨ä¸Š
- [ ] é˜²ç«å¢™ä»…å…è®¸ç‰¹å®š IP åœ°å€
- [ ] å·²ç”Ÿæˆå¹¶é…ç½® mTLS è¯ä¹¦
- [ ] ä¸»åŠ å¯†å¯†é’¥å®‰å…¨å­˜å‚¨ï¼ˆè€ƒè™‘ä½¿ç”¨ HashiCorp Vaultï¼‰
- [ ] æ•°æ®åº“é™æ€åŠ å¯†ï¼ˆç£ç›˜åŠ å¯†ï¼‰
- [ ] PII æ•°æ®åº“æ— ç›´æ¥äº’è”ç½‘è®¿é—®
- [ ] å¯ç”¨æ‰€æœ‰ PII è®¿é—®çš„å®¡è®¡æ—¥å¿—
- [ ] å®šæœŸå¤‡ä»½åŠ å¯†æ•°æ®
- [ ] åˆ¶å®šè¯ä¹¦è½®æ¢è®¡åˆ’ï¼ˆå»ºè®®æ¯å¹´ï¼‰

### DEKï¼ˆæ•°æ®åŠ å¯†å¯†é’¥ï¼‰è½®æ¢

```bash
# ä¸ºç§Ÿæˆ·ç”Ÿæˆæ–°çš„ DEK
curl -X POST https://pii.your-domain.com:5100/admin/rotate-dek \
  --cacert /path/to/ca.crt \
  --cert /path/to/client.crt \
  --key /path/to/client.key \
  -H "Authorization: Bearer ADMIN_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"tenantId": "tenant-uuid"}'
```

---

## ğŸ“š API å‚è€ƒ

### åŸºç¡€ URL

```
{baseUrl}/api/v1
```

### è®¤è¯

æ‰€æœ‰éœ€è¦è®¤è¯çš„ç«¯ç‚¹éœ€è¦ JWT ä»¤ç‰Œï¼š

```bash
curl -X POST /api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"tenantCode": "AC", "username": "admin", "password": "..."}'

# å“åº”åŒ…å« accessToken å¹¶è®¾ç½® refreshToken Cookie
```

### ä¸»è¦ç«¯ç‚¹

| ç±»åˆ« | ç«¯ç‚¹ | æè¿° |
|------|------|------|
| **è®¤è¯** | `POST /auth/login` | ä½¿ç”¨å‡­è¯ç™»å½• |
| | `POST /auth/refresh` | åˆ·æ–°è®¿é—®ä»¤ç‰Œ |
| | `POST /auth/logout` | ç™»å‡ºå¹¶ä½¿ä»¤ç‰Œå¤±æ•ˆ |
| **å®¢æˆ·** | `GET /customers` | è·å–å®¢æˆ·åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰ |
| | `POST /customers` | åˆ›å»ºå®¢æˆ·æ¡£æ¡ˆ |
| | `POST /customers/{id}/request-pii-access` | è·å– PII è®¿é—®ä»¤ç‰Œ |
| **ç»„ç»‡** | `GET /organization/tree` | è·å–ç»„ç»‡ç»“æ„ |
| | `POST /subsidiaries` | åˆ›å»ºåˆ†çº§ç›®å½• |
| | `POST /talents` | åˆ›å»ºè‰ºäºº |
| **æ£‰èŠ±ç³–** | `GET /public/marshmallow/{path}/messages` | è·å–å…¬å¼€æ¶ˆæ¯ |
| | `POST /public/marshmallow/{path}/submit` | æäº¤åŒ¿åé—®é¢˜ |
| | `POST /marshmallow/messages/{id}/approve` | å®¡æ ¸é€šè¿‡æ¶ˆæ¯ |
| **æŠ¥è¡¨** | `POST /reports/mfr/jobs` | å¯åŠ¨ MFR ç”Ÿæˆ |
| | `GET /reports/mfr/jobs/{id}` | è·å–ä»»åŠ¡çŠ¶æ€ |
| | `GET /reports/mfr/jobs/{id}/download` | è·å–ä¸‹è½½ URL |
| **æ—¥å¿—** | `GET /logs/changes` | æŸ¥è¯¢å˜æ›´æ—¥å¿— |
| | `GET /logs/events` | æŸ¥è¯¢ç³»ç»Ÿäº‹ä»¶ |
| | `GET /logs/search` | Loki å…¨æ–‡æœç´¢ |

### å“åº”æ ¼å¼

**æˆåŠŸï¼š**
```json
{
  "success": true,
  "data": { ... },
  "meta": {
    "page": 1,
    "pageSize": 20,
    "total": 100
  }
}
```

**é”™è¯¯ï¼š**
```json
{
  "success": false,
  "code": "AUTH_INVALID_CREDENTIALS",
  "message": "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯",
  "statusCode": 401
}
```

---

## ğŸ” å®‰å…¨æœºåˆ¶

### å¯†ç ç­–ç•¥

- è‡³å°‘ 12 ä¸ªå­—ç¬¦
- è‡³å°‘ 1 ä¸ªå¤§å†™å­—æ¯
- è‡³å°‘ 1 ä¸ªå°å†™å­—æ¯
- è‡³å°‘ 1 ä¸ªæ•°å­—
- è‡³å°‘ 1 ä¸ªç‰¹æ®Šå­—ç¬¦
- 90 å¤©è¿‡æœŸæé†’

### åŒå› ç´ è®¤è¯

åŸºäº TOTP çš„ 2FAï¼Œå¸¦æ¢å¤ç ï¼š
- è®¾ç½®æ—¶ç”Ÿæˆ 10 ä¸ªä¸€æ¬¡æ€§æ¢å¤ç 
- æ¢å¤ç ä»¥ SHA256 å“ˆå¸Œå­˜å‚¨
- ç§Ÿæˆ·ç®¡ç†å‘˜å¯å¼ºåˆ¶æ‰€æœ‰ç”¨æˆ·å¯ç”¨ 2FA

### æ•°æ®ä¿æŠ¤

| æ•°æ®ç±»å‹ | ä¿æŠ¤æ–¹å¼ |
|----------|----------|
| å¯†ç  | bcrypt å“ˆå¸Œï¼ˆcost factor 12ï¼‰ |
| PII | AES-256-GCM åŠ å¯† |
| ä¼šè¯ | çŸ­æœ‰æ•ˆæœŸ JWT |
| API é€šä¿¡ | è¦æ±‚ TLS 1.2+ |
| æœåŠ¡é—´é€šä¿¡ | mTLS è®¤è¯ |

### å®‰å…¨å“åº”å¤´

æ‰€æœ‰å“åº”åŒ…å«ï¼š
- `X-Content-Type-Options: nosniff`
- `X-Frame-Options: DENY`
- `X-XSS-Protection: 1; mode=block`
- `Strict-Transport-Security: max-age=31536000`
- `Content-Security-Policy: ...`

---

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ **PolyForm Noncommercial License 1.0.0** è®¸å¯è¯ã€‚

å•†ä¸šä½¿ç”¨éœ€è¦å•ç‹¬çš„è®¸å¯åè®®ã€‚å¦‚éœ€ä¼ä¸šæˆæƒ/SaaS æœåŠ¡è´­ä¹°ï¼Œè¯·è”ç³» ryan.lan_home@outlook.comã€‚

---

## ğŸ“ æ”¯æŒ

- **æ–‡æ¡£**ï¼š[docs/](./docs/)
- **é—®é¢˜åé¦ˆ**ï¼š[GitHub Issues](https://github.com/tpmoonchefryan/tcrn-tms/issues)
- **è®¨è®ºåŒº**ï¼š[GitHub Discussions](https://github.com/tpmoonchefryan/tcrn-tms/discussions)
